service: nephos-backend

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 30

  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    DYNAMODB_TABLE_METRICS: ${self:custom.dynamoDbTableMetrics}
    DYNAMODB_TABLE_ALERTS: ${self:custom.dynamoDbTableAlerts}
    DYNAMODB_TABLE_INSTANCES: ${self:custom.dynamoDbTableInstances}
    SNOWFLAKE_ACCOUNT: ${env:SNOWFLAKE_ACCOUNT}
    SNOWFLAKE_USERNAME: ${env:SNOWFLAKE_USERNAME}
    SNOWFLAKE_PASSWORD: ${env:SNOWFLAKE_PASSWORD}
    SNOWFLAKE_DATABASE: ${env:SNOWFLAKE_DATABASE}
    SNOWFLAKE_WAREHOUSE: ${env:SNOWFLAKE_WAREHOUSE}
    SNOWFLAKE_SCHEMA: ${env:SNOWFLAKE_SCHEMA}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableMetrics}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableAlerts}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableInstances}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableMetrics}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableAlerts}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableInstances}/index/*
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - dynamodb:DescribeStream
            - dynamodb:GetRecords
            - dynamodb:GetShardIterator
            - dynamodb:ListStreams
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDbTableMetrics}/stream/*

custom:
  dynamoDbTableMetrics: nephos-metrics-${self:provider.stage}
  dynamoDbTableAlerts: nephos-alerts-${self:provider.stage}
  dynamoDbTableInstances: nephos-instances-${self:provider.stage}

functions:
  # API Functions
  metricsApi:
    handler: functions/api/metrics/index.handler
    description: API endpoint for metrics collection and retrieval
    events:
      - httpApi:
          path: /metrics
          method: GET
      - httpApi:
          path: /metrics
          method: POST
      - httpApi:
          path: /metrics/{id}
          method: GET

  alertsApi:
    handler: functions/api/alerts/index.handler
    description: API endpoint for alert management
    events:
      - httpApi:
          path: /alerts
          method: GET
      - httpApi:
          path: /alerts
          method: POST
      - httpApi:
          path: /alerts/{id}
          method: GET
      - httpApi:
          path: /alerts/{id}
          method: PUT
      - httpApi:
          path: /alerts/{id}
          method: DELETE

  analyticsApi:
    handler: functions/api/analytics/index.handler
    description: API endpoint for analytics data
    events:
      - httpApi:
          path: /analytics
          method: GET
      - httpApi:
          path: /analytics/dashboard
          method: GET

  instancesApi:
    handler: functions/api/instances/index.handler
    description: API endpoint for instance management
    events:
      - httpApi:
          path: /instances
          method: GET
      - httpApi:
          path: /instances
          method: POST
      - httpApi:
          path: /instances/{id}
          method: GET
      - httpApi:
          path: /instances/{id}
          method: PUT
      - httpApi:
          path: /instances/{id}
          method: DELETE

  # AI Insights API
  insightsApi:
    handler: functions/api/insights/index.handler
    description: API endpoint for AI-generated insights from Snowflake Cortex
    timeout: 30
    events:
      - httpApi:
          path: /insights
          method: GET
      - httpApi:
          path: /insights/summary
          method: GET
      - httpApi:
          path: /insights/patterns
          method: GET
      - httpApi:
          path: /insights/anomalies
          method: GET
      - httpApi:
          path: /insights/predictions
          method: GET

  # Sentinel Function (Health Checker)
  sentinel:
    handler: functions/sentinel/index.handler
    description: Continuous health check and monitoring service
    timeout: 300
    memorySize: 1024
    events:
      # Run every 5 minutes
      - schedule:
          rate: rate(5 minutes)
          enabled: false  # Enable after implementation
          description: Run sentinel health checks every 5 minutes

  # ETL Function - DynamoDB to Snowflake (Batch Layer)
  dynamoDbToSnowflake:
    handler: functions/etl/dynamodb-to-snowflake/index.handler
    description: ETL pipeline from DynamoDB to Snowflake with AI analysis trigger
    timeout: 900
    memorySize: 2048
    events:
      # Triggered by DynamoDB stream (real-time sync)
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt:
              - MetricsTable
              - StreamArn
          batchSize: 100
          startingPosition: LATEST
          enabled: true
      # Also run on schedule (hourly batch)
      - schedule:
          rate: rate(1 hour)
          enabled: true
          description: Hourly ETL sync to Snowflake and trigger AI analysis

resources:
  Resources:
    # DynamoDB Tables
    MetricsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.dynamoDbTableMetrics}
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: N
          - AttributeName: instanceId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: InstanceIdIndex
            KeySchema:
              - AttributeName: instanceId
                KeyType: HASH
              - AttributeName: timestamp
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: Nephos

    AlertsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.dynamoDbTableAlerts}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: N
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: StatusIndex
            KeySchema:
              - AttributeName: status
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: Nephos

    InstancesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.dynamoDbTableInstances}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: StatusIndex
            KeySchema:
              - AttributeName: status
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: Nephos

  Outputs:
    ApiEndpoint:
      Description: HTTP API endpoint URL
      Value:
        Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
      Export:
        Name: ${self:provider.stage}-ApiEndpoint

    MetricsTableName:
      Description: DynamoDB Metrics table name
      Value: ${self:custom.dynamoDbTableMetrics}
      Export:
        Name: ${self:provider.stage}-MetricsTable

    AlertsTableName:
      Description: DynamoDB Alerts table name
      Value: ${self:custom.dynamoDbTableAlerts}
      Export:
        Name: ${self:provider.stage}-AlertsTable

    InstancesTableName:
      Description: DynamoDB Instances table name
      Value: ${self:custom.dynamoDbTableInstances}
      Export:
        Name: ${self:provider.stage}-InstancesTable

plugins:
  - serverless-offline
